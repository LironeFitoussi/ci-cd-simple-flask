name: CI/CD - DevOps Notes API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    name: CI - Health check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run health check against /health
        env:
          APP_PORT: 8000
        run: |
          python app.py &
          APP_PID=$!
          # המתנה קצרה שהשרת יעלה
          sleep 5
          # curl -f יחזיר קוד שגיאה אם ה-status code לא 2xx
          curl -f http://127.0.0.1:${APP_PORT}/health
          kill $APP_PID

  cd:
    name: CD - Provision EC2 on AWS
    needs: ci
    runs-on: ubuntu-latest
    # CD רק ב-push ל-main (לא ב-PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
      AWS_AMI_ID: ${{ vars.AWS_AMI_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Prepare EC2 user data script
        run: |
          REPO_URL="https://github.com/${GITHUB_REPOSITORY}.git"
          sed "s|__REPO_URL__|$REPO_URL|g" scripts/ec2-userdata.sh > /tmp/devops-notes-userdata.sh

      - name: Create or update security group
        run: |
          SG_NAME="devops-notes-api-sg"

          # אם הקבוצה לא קיימת - צור אותה
          aws ec2 describe-security-groups --group-names "$SG_NAME" >/dev/null 2>&1 || \
            aws ec2 create-security-group --group-name "$SG_NAME" --description "DevOps Notes API security group"

          # פתיחת פורט 8000 ל-HTTP ואפשרות ל-SSH (22) לצורך דיבוג
          aws ec2 authorize-security-group-ingress --group-name "$SG_NAME" --protocol tcp --port 8000 --cidr 0.0.0.0/0 >/dev/null 2>&1 || true
          aws ec2 authorize-security-group-ingress --group-name "$SG_NAME" --protocol tcp --port 22 --cidr 0.0.0.0/0 >/dev/null 2>&1 || true

      - name: Ensure key pair exists
        run: |
          KEY_NAME="devops-notes-api-key"
          aws ec2 describe-key-pairs --key-names "$KEY_NAME" >/dev/null 2>&1 || \
            aws ec2 create-key-pair --key-name "$KEY_NAME" >/dev/null

      - name: Terminate existing instance (same tag)
        run: |
          TAG_NAME="devops-notes-api"
          # חיפוש instance קיים עם התג הייחודי (running או pending)
          EXISTING=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=$TAG_NAME" "Name=instance-state-name,Values=running,pending" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text)
          if [ -n "$EXISTING" ]; then
            echo "Terminating existing instance(s): $EXISTING"
            aws ec2 terminate-instances --instance-ids $EXISTING
            echo "Waiting for instance(s) to terminate..."
            aws ec2 wait instance-terminated --instance-ids $EXISTING
          else
            echo "No existing instance with tag Name=$TAG_NAME"
          fi

      - name: Launch EC2 instance
        run: |
          SG_NAME="devops-notes-api-sg"
          KEY_NAME="devops-notes-api-key"
          INSTANCE_TYPE="t3.micro"
          TAG_NAME="devops-notes-api"
          AMI_ID="${AWS_AMI_ID}"

          if [ -z "$AMI_ID" ]; then
            echo "AWS_AMI_ID variable is not set. Define it as a repository variable (Settings → Variables → Actions)."
            exit 1
          fi

          aws ec2 run-instances \
            --image-id "$AMI_ID" \
            --instance-type "$INSTANCE_TYPE" \
            --security-groups "$SG_NAME" \
            --key-name "$KEY_NAME" \
            --user-data file:///tmp/devops-notes-userdata.sh \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=$TAG_NAME}]"